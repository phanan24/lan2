<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bảng Tuần Hoàn 3D - LimVA</title>
  <style>
    html, body {
      height: 100%;
    }

    body {
      background-color: #000000;
      margin: 0;
      font-family: Helvetica, sans-serif;
      overflow: hidden;
    }

    a {
      color: #ffffff;
    }

    #info {
      position: absolute;
      width: 100%;
      color: #ffffff;
      padding: 5px;
      font-family: Monospace;
      font-size: 13px;
      font-weight: bold;
      text-align: center;
      z-index: 1;
    }

    #menu {
      position: absolute;
      bottom: 20px;
      width: 100%;
      text-align: center;
      font-family: verdana,Tahoma,Arial,Hei,"Microsoft Yahei",SimHei;
    }

    .element {
      width: 120px;
      height: 160px;
      box-shadow: 0px 0px 12px rgba(0,255,255,0.5);
      border: 1px solid rgba(127,255,255,0.25);
      text-align: center;
      cursor: default;
    }

    .element:hover {
      box-shadow: 0px 0px 12px rgba(0,255,255,0.75);
      border: 1px solid rgba(127,255,255,0.75);
    }

    .element .number {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 12px;
      color: rgba(127,255,255,0.75);
    }

    .element .symbol {
      position: absolute;
      top: 40px;
      left: 0px;
      right: 0px;
      font-size: 60px;
      font-weight: bold;
      color: rgba(255,255,255,0.75);
      text-shadow: 0 0 10px rgba(0,255,255,0.95);
    }

    .element .details {
      position: absolute;
      bottom: 15px;
      left: 0px;
      right: 0px;
      font-size: 12px;
      color: rgba(127,255,255,0.75);
    }

    button {
      color: rgba(127,255,255,0.75);
      background: transparent;
      outline: 1px solid rgba(127,255,255,0.75);
      border: 0px;
      padding: 5px 10px;
      cursor: pointer;
      margin: 0 5px;
    }
    button:hover {
      background-color: rgba(0,255,255,0.5);
    }
    button:active {
      color: #000000;
      background-color: rgba(0,255,255,0.75);
    }
  </style>
</head>
<body>
  <div id="container"></div>
  <div id="info">Bảng Tuần Hoàn Hóa Học 3D LimVA</div>
  <div id="menu">
    <button id="table">Bảng Cổ Điển</button>
    <button id="sphere">Hình Cầu</button>
    <button id="helix">Đường Xoắn Ốc</button>
    <button id="grid">Dạng Lưới</button>
  </div>

  <script src='https://cdnjs.cloudflare.com/ajax/libs/three.js/r67/three.min.js'></script>
  <script>
    // tween.js - https://github.com/sole/tween.js
    'use strict';
    var TWEEN = TWEEN || function() {
        var a = [];
        return {
            REVISION: "7",
            getAll: function() {
                return a
            },
            removeAll: function() {
                a = []
            },
            add: function(c) {
                a.push(c)
            },
            remove: function(c) {
                c = a.indexOf(c);
                - 1 !== c && a.splice(c, 1)
            },
            update: function(c) {
                if (0 === a.length)
                    return !1;
                for (var b = 0, d = a.length, c = void 0 !== c ? c : Date.now(); b < d;)
                    a[b].update(c) ? b++ : (a.splice(b, 1), d--);
                return !0
            }
        }
    }();

    TWEEN.Tween = function(a) {
        var c = {}, b = {}, d = 1E3, e = 0, f = null, h = TWEEN.Easing.Linear.None, r = TWEEN.Interpolation.Linear, k = [], l = null, m=!1, n = null, p = null;
        this.to = function(a, c) {
            null !== c && (d = c);
            b = a;
            return this
        };
        this.start = function(d) {
            TWEEN.add(this);
            m=!1;
            f = void 0 !== d ? d : Date.now();
            f += e;
            for (var g in b)
                if (null !== a[g]) {
                    if (b[g]instanceof Array) {
                        if (0 === b[g].length)
                            continue;
                            b[g] = [a[g]].concat(b[g])
                        }
                        c[g] = a[g]
                }
            return this
        };
        this.stop = function() {
            TWEEN.remove(this);
            return this
        };
        this.delay = function(a) {
            e = a;
            return this
        };
        this.easing = function(a) {
            h = a;
            return this
        };
        this.interpolation = function(a) {
            r = a;
            return this
        };
        this.chain = function() {
            k = arguments;
            return this
        };
        this.onStart = function(a) {
            l = a;
            return this
        };
        this.onUpdate = function(a) {
            n = a;
            return this
        };
        this.onComplete = function(a) {
            p = a;
            return this
        };
        this.update = function(e) {
            if (e < f)
                return !0;
            !1 === m && (null !== l && l.call(a), m=!0);
            var g = (e - f) / d, g = 1 < g ? 1: g, i = h(g), j;
            for (j in c) {
                var s = c[j], q = b[j];
                a[j] = q instanceof Array ? r(q, i) : s + (q - s) * i
            }
            null !== n && n.call(a, i);
            if (1 == g) {
                null !== p && p.call(a);
                g = 0;
                for (i = k.length; g < i; g++)
                    k[g].start(e);
                return !1
            }
            return !0
        }
    };

    TWEEN.Easing = {
        Linear: {
            None: function(a) {
                return a
            }
        },
        Quadratic: {
            In: function(a) {
                return a * a
            },
            Out: function(a) {
                return a * (2 - a)
            },
            InOut: function(a) {
                return 1 > (a*=2) ? 0.5 * a * a : - 0.5 * (--a * (a - 2) - 1)
            }
        },
        Cubic: {
            In: function(a) {
                return a * a * a
            },
            Out: function(a) {
                return --a * a * a + 1
            },
            InOut: function(a) {
                return 1 > (a*=2) ? 0.5 * a * a * a : 0.5 * ((a -= 2) * a * a + 2)
            }
        }
    };

    TWEEN.Interpolation = {
        Linear: function(a, c) {
            var b = a.length - 1, d = b * c, e = Math.floor(d), f = TWEEN.Interpolation.Utils.Linear;
            return 0 > c ? f(a[0], a[1], d) : 1 < c ? f(a[b], a[b - 1], b - d) : f(a[e], a[e + 1 > b ? b : e + 1], d - e)
        },
        Utils: {
            Linear: function(a, c, b) {
                return (c - a) * b + a
            }
        }
    };

    // Main 3D Periodic Table Implementation
    var table = [
        "H", "Hydrogen", "1.00794", 1, 1,
        "He", "Helium", "4.002602", 18, 1,
        "Li", "Lithium", "6.941", 1, 2,
        "Be", "Beryllium", "9.012182", 2, 2,
        "B", "Boron", "10.811", 13, 2,
        "C", "Carbon", "12.0107", 14, 2,
        "N", "Nitrogen", "14.0067", 15, 2,
        "O", "Oxygen", "15.9994", 16, 2,
        "F", "Fluorine", "18.9984032", 17, 2,
        "Ne", "Neon", "20.1797", 18, 2,
        "Na", "Sodium", "22.98976928", 1, 3,
        "Mg", "Magnesium", "24.3050", 2, 3,
        "Al", "Aluminium", "26.9815386", 13, 3,
        "Si", "Silicon", "28.0855", 14, 3,
        "P", "Phosphorus", "30.973762", 15, 3,
        "S", "Sulfur", "32.065", 16, 3,
        "Cl", "Chlorine", "35.453", 17, 3,
        "Ar", "Argon", "39.948", 18, 3
    ];

    var camera, scene, renderer;
    var controls;
    var objects = [];
    var targets = { table: [], sphere: [], helix: [], grid: [] };

    init();
    animate();

    function init() {
        camera = new THREE.PerspectiveCamera( 40, window.innerWidth / window.innerHeight, 1, 10000 );
        camera.position.z = 3000;

        scene = new THREE.Scene();

        // table
        for ( var i = 0; i < table.length; i += 5 ) {
            var element = document.createElement( 'div' );
            element.className = 'element';
            element.style.backgroundColor = 'rgba(0,127,127,' + ( Math.random() * 0.5 + 0.25 ) + ')';

            var number = document.createElement( 'div' );
            number.className = 'number';
            number.textContent = (i/5) + 1;
            element.appendChild( number );

            var symbol = document.createElement( 'div' );
            symbol.className = 'symbol';
            symbol.textContent = table[ i ];
            element.appendChild( symbol );

            var details = document.createElement( 'div' );
            details.className = 'details';
            details.innerHTML = table[ i + 1 ] + '<br>' + table[ i + 2 ];
            element.appendChild( details );

            var object = new THREE.CSS3DObject( element );
            object.position.x = Math.random() * 4000 - 2000;
            object.position.y = Math.random() * 4000 - 2000;
            object.position.z = Math.random() * 4000 - 2000;
            scene.add( object );

            objects.push( object );

            //
            var object = new THREE.Object3D();
            object.position.x = ( table[ i + 3 ] * 140 ) - 1330;
            object.position.y = - ( table[ i + 4 ] * 180 ) + 990;

            targets.table.push( object );
        }

        // sphere
        var vector = new THREE.Vector3();
        for ( var i = 0, l = objects.length; i < l; i ++ ) {
            var phi = Math.acos( -1 + ( 2 * i ) / l );
            var theta = Math.sqrt( l * Math.PI ) * phi;

            var object = new THREE.Object3D();

            object.position.x = 800 * Math.cos( theta ) * Math.sin( phi );
            object.position.y = 800 * Math.sin( theta ) * Math.sin( phi );
            object.position.z = 800 * Math.cos( phi );

            vector.copy( object.position ).multiplyScalar( 2 );

            object.lookAt( vector );

            targets.sphere.push( object );
        }

        // helix
        var vector = new THREE.Vector3();
        for ( var i = 0, l = objects.length; i < l; i ++ ) {
            var phi = i * 0.175 + Math.PI;

            var object = new THREE.Object3D();

            object.position.x = 900 * Math.sin( phi );
            object.position.y = - ( i * 8 ) + 450;
            object.position.z = 900 * Math.cos( phi );

            vector.copy( object.position );
            vector.x *= 2;
            vector.z *= 2;

            object.lookAt( vector );

            targets.helix.push( object );
        }

        // grid
        for ( var i = 0; i < objects.length; i ++ ) {
            var object = new THREE.Object3D();

            object.position.x = ( ( i % 5 ) * 400 ) - 800;
            object.position.y = ( - ( Math.floor( i / 5 ) % 5 ) * 400 ) + 800;
            object.position.z = ( Math.floor( i / 25 ) ) * 1000 - 2000;

            targets.grid.push( object );
        }

        //
        renderer = new THREE.CSS3DRenderer();
        renderer.setSize( window.innerWidth, window.innerHeight );
        renderer.domElement.style.position = 'absolute';
        document.getElementById( 'container' ).appendChild( renderer.domElement );

        //
        controls = new THREE.TrackballControls( camera, renderer.domElement );
        controls.rotateSpeed = 0.5;
        controls.minDistance = 500;
        controls.maxDistance = 6000;
        controls.addEventListener( 'change', render );

        var button = document.getElementById( 'table' );
        button.addEventListener( 'click', function ( event ) {
            transform( targets.table, 2000 );
        }, false );

        var button = document.getElementById( 'sphere' );
        button.addEventListener( 'click', function ( event ) {
            transform( targets.sphere, 2000 );
        }, false );

        var button = document.getElementById( 'helix' );
        button.addEventListener( 'click', function ( event ) {
            transform( targets.helix, 2000 );
        }, false );

        var button = document.getElementById( 'grid' );
        button.addEventListener( 'click', function ( event ) {
            transform( targets.grid, 2000 );
        }, false );

        transform( targets.table, 2000 );

        //
        window.addEventListener( 'resize', onWindowResize, false );
    }

    function transform( targets, duration ) {
        TWEEN.removeAll();

        for ( var i = 0; i < objects.length; i ++ ) {
            var object = objects[ i ];
            var target = targets[ i ];

            new TWEEN.Tween( object.position )
                .to( { x: target.position.x, y: target.position.y, z: target.position.z }, Math.random() * duration + duration )
                .easing( TWEEN.Easing.Cubic.InOut )
                .start();

            new TWEEN.Tween( object.rotation )
                .to( { x: target.rotation.x, y: target.rotation.y, z: target.rotation.z }, Math.random() * duration + duration )
                .easing( TWEEN.Easing.Cubic.InOut )
                .start();
        }

        new TWEEN.Tween( this )
            .to( {}, duration * 2 )
            .onUpdate( render )
            .start();
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();

        renderer.setSize( window.innerWidth, window.innerHeight );

        render();
    }

    function animate() {
        requestAnimationFrame( animate );

        TWEEN.update();
        controls.update();
    }

    function render() {
        renderer.render( scene, camera );
    }

    // Add CSS3DRenderer
    THREE.CSS3DRenderer = function () {
        var _width, _height;
        var _widthHalf, _heightHalf;

        var matrix = new THREE.Matrix4();

        var domElement = document.createElement( 'div' );
        domElement.style.overflow = 'hidden';

        this.domElement = domElement;

        this.setSize = function ( width, height ) {
            _width = width;
            _height = height;
            _widthHalf = _width / 2;
            _heightHalf = _height / 2;

            domElement.style.width = width + 'px';
            domElement.style.height = height + 'px';
        };

        this.render = function ( scene, camera ) {
            scene.updateMatrixWorld();

            if ( camera.parent === null ) camera.updateMatrixWorld();

            camera.matrixWorldInverse.getInverse( camera.matrixWorld );

            var style = "translate3d(-50%,-50%,0) matrix3d(" +
                "1,0,0,0," +
                "0,1,0,0," +
                "0,0,1,0," +
                _widthHalf + "," + _heightHalf + ",0,1) scale3d(" + _widthHalf + "," + _heightHalf + ",1)";

            domElement.style.transform = style;

            renderObject( scene, camera );
        };

        var renderObject = function ( object, camera ) {
            if ( object instanceof THREE.CSS3DObject ) {
                var element = object.element;
                var style;

                matrix.multiplyMatrices( camera.matrixWorldInverse, object.matrixWorld );

                var elements = matrix.elements;

                style = 'translate3d(-50%,-50%,0) matrix3d(' +
                    epsilon( elements[ 0 ] ) + ',' +
                    epsilon( elements[ 1 ] ) + ',' +
                    epsilon( elements[ 2 ] ) + ',' +
                    epsilon( elements[ 3 ] ) + ',' +
                    epsilon( - elements[ 4 ] ) + ',' +
                    epsilon( - elements[ 5 ] ) + ',' +
                    epsilon( - elements[ 6 ] ) + ',' +
                    epsilon( - elements[ 7 ] ) + ',' +
                    epsilon( elements[ 8 ] ) + ',' +
                    epsilon( elements[ 9 ] ) + ',' +
                    epsilon( elements[ 10 ] ) + ',' +
                    epsilon( elements[ 11 ] ) + ',' +
                    epsilon( elements[ 12 ] ) + ',' +
                    epsilon( elements[ 13 ] ) + ',' +
                    epsilon( elements[ 14 ] ) + ',' +
                    epsilon( elements[ 15 ] ) +
                ')';

                element.style.transform = style;

                if ( element.parentNode !== domElement ) {
                    domElement.appendChild( element );
                }
            }

            for ( var i = 0, l = object.children.length; i < l; i ++ ) {
                renderObject( object.children[ i ], camera );
            }
        };

        var epsilon = function ( value ) {
            return Math.abs( value ) < 1e-10 ? 0 : value;
        };
    };

    THREE.CSS3DObject = function ( element ) {
        THREE.Object3D.call( this );

        this.element = element;
        this.element.style.position = 'absolute';

        this.addEventListener( 'removed', function ( event ) {
            if ( this.element.parentNode !== null ) {
                this.element.parentNode.removeChild( this.element );
            }
        } );
    };

    THREE.CSS3DObject.prototype = Object.create( THREE.Object3D.prototype );
    THREE.CSS3DObject.prototype.constructor = THREE.CSS3DObject;

    // TrackballControls
    THREE.TrackballControls = function ( object, domElement ) {
        var _this = this;
        var STATE = { NONE: - 1, ROTATE: 0, ZOOM: 1, PAN: 2, TOUCH_ROTATE: 3, TOUCH_ZOOM_PAN: 4 };

        this.object = object;
        this.domElement = ( domElement !== undefined ) ? domElement : document;

        // API
        this.enabled = true;
        this.screen = { left: 0, top: 0, width: 0, height: 0 };
        this.rotateSpeed = 1.0;
        this.zoomSpeed = 1.2;
        this.panSpeed = 0.3;
        this.noRotate = false;
        this.noZoom = false;
        this.noPan = false;
        this.staticMoving = false;
        this.dynamicDampingFactor = 0.2;
        this.minDistance = 0;
        this.maxDistance = Infinity;
        this.keys = [ 65 /*A*/, 83 /*S*/, 68 /*D*/ ];

        // internals
        this.target = new THREE.Vector3();
        var EPS = 0.000001;
        var lastPosition = new THREE.Vector3();
        var _state = STATE.NONE,
        _prevState = STATE.NONE,
        _eye = new THREE.Vector3(),
        _movePrev = new THREE.Vector2(),
        _moveCurr = new THREE.Vector2(),
        _lastAxis = new THREE.Vector3(),
        _lastAngle = 0,
        _zoomStart = new THREE.Vector2(),
        _zoomEnd = new THREE.Vector2(),
        _touchZoomDistanceStart = 0,
        _touchZoomDistanceEnd = 0,
        _panStart = new THREE.Vector2(),
        _panEnd = new THREE.Vector2();

        // for reset
        this.target0 = this.target.clone();
        this.position0 = this.object.position.clone();
        this.up0 = this.object.up.clone();

        // events
        var changeEvent = { type: 'change' };
        var startEvent = { type: 'start' };
        var endEvent = { type: 'end' };

        // methods
        this.handleResize = function () {
            if ( this.domElement === document ) {
                this.screen.left = 0;
                this.screen.top = 0;
                this.screen.width = window.innerWidth;
                this.screen.height = window.innerHeight;
            } else {
                var box = this.domElement.getBoundingClientRect();
                var d = this.domElement.ownerDocument.documentElement;
                this.screen.left = box.left + window.pageXOffset - d.clientLeft;
                this.screen.top = box.top + window.pageYOffset - d.clientTop;
                this.screen.width = box.width;
                this.screen.height = box.height;
            }
        };

        this.handleEvent = function ( event ) {
            if ( typeof this[ event.type ] == 'function' ) {
                this[ event.type ]( event );
            }
        };

        var getMouseOnScreen = ( function () {
            var vector = new THREE.Vector2();
            return function getMouseOnScreen( pageX, pageY ) {
                vector.set(
                    ( pageX - _this.screen.left ) / _this.screen.width,
                    ( pageY - _this.screen.top ) / _this.screen.height
                );
                return vector;
            };
        }() );

        var getMouseOnCircle = ( function () {
            var vector = new THREE.Vector2();
            return function getMouseOnCircle( pageX, pageY ) {
                vector.set(
                    ( ( pageX - _this.screen.width * 0.5 - _this.screen.left ) / ( _this.screen.width * 0.5 ) ),
                    ( ( _this.screen.height + 2 * ( _this.screen.top - pageY ) ) / _this.screen.width )
                );
                return vector;
            };
        }() );

        this.rotateCamera = ( function () {
            var axis = new THREE.Vector3(),
                quaternion = new THREE.Quaternion(),
                eyeDirection = new THREE.Vector3(),
                objectUpDirection = new THREE.Vector3(),
                objectSidewaysDirection = new THREE.Vector3(),
                moveDirection = new THREE.Vector3(),
                angle;

            return function rotateCamera() {
                moveDirection.set( _moveCurr.x - _movePrev.x, _moveCurr.y - _movePrev.y, 0 );
                angle = moveDirection.length();

                if ( angle ) {
                    _eye.copy( _this.object.position ).sub( _this.target );

                    eyeDirection.copy( _eye ).normalize();
                    objectUpDirection.copy( _this.object.up ).normalize();
                    objectSidewaysDirection.crossVectors( objectUpDirection, eyeDirection ).normalize();

                    objectUpDirection.setLength( _moveCurr.y - _movePrev.y );
                    objectSidewaysDirection.setLength( _moveCurr.x - _movePrev.x );

                    moveDirection.copy( objectUpDirection.add( objectSidewaysDirection ) );

                    axis.crossVectors( moveDirection, _eye ).normalize();

                    angle *= _this.rotateSpeed;
                    quaternion.setFromAxisAngle( axis, angle );

                    _eye.applyQuaternion( quaternion );
                    _this.object.up.applyQuaternion( quaternion );

                    _lastAxis.copy( axis );
                    _lastAngle = angle;

                } else if ( ! _this.staticMoving && _lastAngle ) {
                    _lastAngle *= Math.sqrt( 1.0 - _this.dynamicDampingFactor );
                    _eye.copy( _this.object.position ).sub( _this.target );
                    quaternion.setFromAxisAngle( _lastAxis, _lastAngle );
                    _eye.applyQuaternion( quaternion );
                    _this.object.up.applyQuaternion( quaternion );
                }

                _movePrev.copy( _moveCurr );
            };
        }() );

        this.zoomCamera = function () {
            var factor;

            if ( _state === STATE.TOUCH_ZOOM_PAN ) {
                factor = _touchZoomDistanceStart / _touchZoomDistanceEnd;
                _touchZoomDistanceStart = _touchZoomDistanceEnd;
                _eye.multiplyScalar( factor );

            } else {
                factor = 1.0 + ( _zoomEnd.y - _zoomStart.y ) * _this.zoomSpeed;

                if ( factor !== 1.0 && factor > 0.0 ) {
                    _eye.multiplyScalar( factor );
                }

                if ( _this.staticMoving ) {
                    _zoomStart.copy( _zoomEnd );
                } else {
                    _zoomStart.y += ( _zoomEnd.y - _zoomStart.y ) * this.dynamicDampingFactor;
                }
            }
        };

        this.panCamera = ( function () {
            var mouseChange = new THREE.Vector2(),
                objectUp = new THREE.Vector3(),
                pan = new THREE.Vector3();

            return function panCamera() {
                mouseChange.copy( _panEnd ).sub( _panStart );

                if ( mouseChange.lengthSq() ) {
                    mouseChange.multiplyScalar( _eye.length() * _this.panSpeed );

                    pan.copy( _eye ).cross( _this.object.up ).setLength( mouseChange.x );
                    pan.add( objectUp.copy( _this.object.up ).setLength( mouseChange.y ) );

                    _this.object.position.add( pan );
                    _this.target.add( pan );

                    if ( _this.staticMoving ) {
                        _panStart.copy( _panEnd );
                    } else {
                        _panStart.add( mouseChange.subVectors( _panEnd, _panStart ).multiplyScalar( _this.dynamicDampingFactor ) );
                    }
                }
            };
        }() );

        this.checkDistances = function () {
            if ( ! _this.noZoom || ! _this.noPan ) {
                if ( _eye.lengthSq() > _this.maxDistance * _this.maxDistance ) {
                    _this.object.position.addVectors( _this.target, _eye.setLength( _this.maxDistance ) );
                    _zoomStart.copy( _zoomEnd );
                }

                if ( _eye.lengthSq() < _this.minDistance * _this.minDistance ) {
                    _this.object.position.addVectors( _this.target, _eye.setLength( _this.minDistance ) );
                    _zoomStart.copy( _zoomEnd );
                }
            }
        };

        this.update = function () {
            _eye.subVectors( _this.object.position, _this.target );

            if ( ! _this.noRotate ) {
                _this.rotateCamera();
            }

            if ( ! _this.noZoom ) {
                _this.zoomCamera();
            }

            if ( ! _this.noPan ) {
                _this.panCamera();
            }

            _this.object.position.addVectors( _this.target, _eye );

            _this.checkDistances();

            _this.object.lookAt( _this.target );

            if ( lastPosition.distanceToSquared( _this.object.position ) > EPS ) {
                _this.dispatchEvent( changeEvent );
                lastPosition.copy( _this.object.position );
            }
        };

        this.reset = function () {
            _state = STATE.NONE;
            _prevState = STATE.NONE;

            _this.target.copy( _this.target0 );
            _this.object.position.copy( _this.position0 );
            _this.object.up.copy( _this.up0 );

            _eye.subVectors( _this.object.position, _this.target );

            _this.object.lookAt( _this.target );

            _this.dispatchEvent( changeEvent );

            lastPosition.copy( _this.object.position );
        };

        // listeners
        function keydown( event ) {
            if ( _this.enabled === false ) return;

            window.removeEventListener( 'keydown', keydown );

            _prevState = _state;

            if ( _state !== STATE.NONE ) {
                return;
            } else if ( event.keyCode === _this.keys[ STATE.ROTATE ] && ! _this.noRotate ) {
                _state = STATE.ROTATE;
            } else if ( event.keyCode === _this.keys[ STATE.ZOOM ] && ! _this.noZoom ) {
                _state = STATE.ZOOM;
            } else if ( event.keyCode === _this.keys[ STATE.PAN ] && ! _this.noPan ) {
                _state = STATE.PAN;
            }
        }

        function keyup( event ) {
            if ( _this.enabled === false ) return;

            _state = _prevState;

            window.addEventListener( 'keydown', keydown, false );
        }

        function mousedown( event ) {
            if ( _this.enabled === false ) return;

            event.preventDefault();
            event.stopPropagation();

            if ( _state === STATE.NONE ) {
                _state = event.button;
            }

            if ( _state === STATE.ROTATE && ! _this.noRotate ) {
                _moveCurr.copy( getMouseOnCircle( event.pageX, event.pageY ) );
                _movePrev.copy( _moveCurr );

            } else if ( _state === STATE.ZOOM && ! _this.noZoom ) {
                _zoomStart.copy( getMouseOnScreen( event.pageX, event.pageY ) );
                _zoomEnd.copy( _zoomStart );

            } else if ( _state === STATE.PAN && ! _this.noPan ) {
                _panStart.copy( getMouseOnScreen( event.pageX, event.pageY ) );
                _panEnd.copy( _panStart );
            }

            document.addEventListener( 'mousemove', mousemove, false );
            document.addEventListener( 'mouseup', mouseup, false );

            _this.dispatchEvent( startEvent );
        }

        function mousemove( event ) {
            if ( _this.enabled === false ) return;

            event.preventDefault();
            event.stopPropagation();

            if ( _state === STATE.ROTATE && ! _this.noRotate ) {
                _movePrev.copy( _moveCurr );
                _moveCurr.copy( getMouseOnCircle( event.pageX, event.pageY ) );

            } else if ( _state === STATE.ZOOM && ! _this.noZoom ) {
                _zoomEnd.copy( getMouseOnScreen( event.pageX, event.pageY ) );

            } else if ( _state === STATE.PAN && ! _this.noPan ) {
                _panEnd.copy( getMouseOnScreen( event.pageX, event.pageY ) );
            }
        }

        function mouseup( event ) {
            if ( _this.enabled === false ) return;

            event.preventDefault();
            event.stopPropagation();

            _state = STATE.NONE;

            document.removeEventListener( 'mousemove', mousemove );
            document.removeEventListener( 'mouseup', mouseup );
            _this.dispatchEvent( endEvent );
        }

        function mousewheel( event ) {
            if ( _this.enabled === false ) return;

            event.preventDefault();
            event.stopPropagation();

            switch ( event.deltaMode ) {
                case 2:
                    _zoomStart.y -= event.deltaY * 0.025;
                    break;

                case 1:
                    _zoomStart.y -= event.deltaY * 0.01;
                    break;

                default:
                    _zoomStart.y -= event.deltaY * 0.00025;
                    break;
            }

            _this.dispatchEvent( startEvent );
            _this.dispatchEvent( endEvent );
        }

        function touchstart( event ) {
            if ( _this.enabled === false ) return;

            switch ( event.touches.length ) {
                case 1:
                    _state = STATE.TOUCH_ROTATE;
                    _moveCurr.copy( getMouseOnCircle( event.touches[ 0 ].pageX, event.touches[ 0 ].pageY ) );
                    _movePrev.copy( _moveCurr );
                    break;

                default:
                    _state = STATE.TOUCH_ZOOM_PAN;
                    var dx = event.touches[ 0 ].pageX - event.touches[ 1 ].pageX;
                    var dy = event.touches[ 0 ].pageY - event.touches[ 1 ].pageY;
                    _touchZoomDistanceEnd = _touchZoomDistanceStart = Math.sqrt( dx * dx + dy * dy );

                    var x = ( event.touches[ 0 ].pageX + event.touches[ 1 ].pageX ) / 2;
                    var y = ( event.touches[ 0 ].pageY + event.touches[ 1 ].pageY ) / 2;
                    _panStart.copy( getMouseOnScreen( x, y ) );
                    _panEnd.copy( _panStart );
                    break;
            }

            _this.dispatchEvent( startEvent );
        }

        function touchmove( event ) {
            if ( _this.enabled === false ) return;

            event.preventDefault();
            event.stopPropagation();

            switch ( event.touches.length ) {
                case 1:
                    _movePrev.copy( _moveCurr );
                    _moveCurr.copy( getMouseOnCircle( event.touches[ 0 ].pageX, event.touches[ 0 ].pageY ) );
                    break;

                default:
                    var dx = event.touches[ 0 ].pageX - event.touches[ 1 ].pageX;
                    var dy = event.touches[ 0 ].pageY - event.touches[ 1 ].pageY;
                    _touchZoomDistanceEnd = Math.sqrt( dx * dx + dy * dy );

                    var x = ( event.touches[ 0 ].pageX + event.touches[ 1 ].pageX ) / 2;
                    var y = ( event.touches[ 0 ].pageY + event.touches[ 1 ].pageY ) / 2;
                    _panEnd.copy( getMouseOnScreen( x, y ) );
                    break;
            }
        }

        function touchend( event ) {
            if ( _this.enabled === false ) return;

            switch ( event.touches.length ) {
                case 0:
                    _state = STATE.NONE;
                    break;

                case 1:
                    _state = STATE.TOUCH_ROTATE;
                    _moveCurr.copy( getMouseOnCircle( event.touches[ 0 ].pageX, event.touches[ 0 ].pageY ) );
                    _movePrev.copy( _moveCurr );
                    break;
            }

            _this.dispatchEvent( endEvent );
        }

        function contextmenu( event ) {
            if ( _this.enabled === false ) return;

            event.preventDefault();
        }

        this.dispose = function () {
            this.domElement.removeEventListener( 'contextmenu', contextmenu, false );
            this.domElement.removeEventListener( 'mousedown', mousedown, false );
            this.domElement.removeEventListener( 'wheel', mousewheel, false );

            this.domElement.removeEventListener( 'touchstart', touchstart, false );
            this.domElement.removeEventListener( 'touchend', touchend, false );
            this.domElement.removeEventListener( 'touchmove', touchmove, false );

            document.removeEventListener( 'mousemove', mousemove, false );
            document.removeEventListener( 'mouseup', mouseup, false );

            window.removeEventListener( 'keydown', keydown, false );
            window.removeEventListener( 'keyup', keyup, false );
        };

        this.domElement.addEventListener( 'contextmenu', contextmenu, false );
        this.domElement.addEventListener( 'mousedown', mousedown, false );
        this.domElement.addEventListener( 'wheel', mousewheel, false );

        this.domElement.addEventListener( 'touchstart', touchstart, false );
        this.domElement.addEventListener( 'touchend', touchend, false );
        this.domElement.addEventListener( 'touchmove', touchmove, false );

        window.addEventListener( 'keydown', keydown, false );
        window.addEventListener( 'keyup', keyup, false );

        this.handleResize();

        // force an update at start
        this.update();
    };

    THREE.TrackballControls.prototype = Object.create( THREE.EventDispatcher.prototype );
    THREE.TrackballControls.prototype.constructor = THREE.TrackballControls;
  </script>
</body>
</html>